<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>回调页面</title>
    <script src="https://cdn.bootcss.com/jquery/1.11.3/jquery.js"></script>
</head>

<body>
    <script>
        //console.log(window.location);
        var search = window.location.search;
        var code = parseSearch(search)["code"];
        var returnUrl = "https://guoenyue.github.io/getMStoken2/demo.html";
        var refresh_token = '';
        var access_token = '';
        var client_assertion = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Im9PdmN6NU1fN3AtSGpJS2xGWHo5M3VfVjBabyJ9.eyJjaWQiOiJkYzg1MDVkYy0zODJiLTQzNTktODM3Yi01NmFiNjc5OGJmNzEiLCJjc2kiOiI1NThkZGY2OS03OWM1LTQwYjYtOGRkZS0xMGZjNGNlMDRmZjAiLCJuYW1laWQiOiJmYTg5YjYyMC01YWFhLTZmMTctOTU0NC01YjgxYWY2NjhlNDIiLCJpc3MiOiJhcHAudnNzcHMudmlzdWFsc3R1ZGlvLmNvbSIsImF1ZCI6ImFwcC52c3Nwcy52aXN1YWxzdHVkaW8uY29tIiwibmJmIjoxNTExNDg5MjQzLCJleHAiOjE2NjkyNTU2NDN9.KCknHsYNq8L7XY1WzL7Jmoox0kYUdw-CuyAf_cwZbwMxZo8VfADE4ZmKHmaALkG6QTug2SIULiDkpg_rOfPspayIox7eQRZuHBE6kzaw34Js_FUifHK9WMXysZi1qBqwOhgiYZejpkHT5CBbqX3ZlGhRczPYMvxRyB3PKvXt4OpJHMa1HuNCyARbBqkdOu_v5UkjLZTKssuN66pYF7hXtg9wL7CPbXOtT95p1kqNN1UEXRlEpViDOZ9Vff7UVZUfLJiL3x-ofe-OxDb8s7nmUGfJZD0X1TCFyr8WVhwjnUn63_04obHci5W_9FXG2JqZHD4lElaxR17j4SWg-hO3dQ";
        var postDataToGetToken = `client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer&client_assertion=${client_assertion}&grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${code}&redirect_uri=${returnUrl}`;
        var postDataToRefreshToken = `client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer&client_assertion=${client_assertion}&grant_type=refresh_token&assertion=${refresh_token}&redirect_uri=${returnUrl}`;
        var accountName = "playerauctions";

        getToken()

        function getMyProfile() {
            var postUrl = `https://${accountName}.visualstudio.com/_apis/profile/profiles/me?api-version=1.0`;
            $.ajax({
                url: postUrl,
                type: "GET",
                dataType: "json",
                headers: {
                    Authorization: "Bearer " + access_token
                }
            }).success((data) => {
                console.log(data);
            }).fail((err) => {
                console.log(err);
            }).complete(() => {});
        }



        function setToken(data) {
            refresh_token = data.refresh_token;
            access_token = data.refresh_token;
            console.log("包含token的对象是", data);
            getMyProfile();
        }


        function getToken() {
            $.ajax({
                url: "https://app.vssps.visualstudio.com/oauth2/token",
                type: "POST",
                data: postDataToGetToken,
                headers: {
                    //"Content-Type": "application/x-www-form-urlencoded",
                    "Content-Length": 1322
                }
            }).success((data) => {
                console.log(data);
                setToken(data);
            }).fail((err) => {
                console.log(err);
            }).complete(() => {

            });
        };

        function refreshToken() {
            $.ajax({
                url: "https://app.vssps.visualstudio.com/oauth2/token",
                type: "POST",
                data: postDataToRefreshToken,
                headers: {
                    //"Content-Type": "application/x-www-form-urlencoded",
                    "Content-Length": 1654
                }
            }).success((data) => {
                console.log(data);
                setToken(data);
            }).fail((err) => {
                console.log(err);
            }).complete(() => {

            });
        }


        function parseSearch(mySearch) {
            var _search = mySearch.slice(1, );
            var _searchArr = _search.split("&");
            var _json = {};
            _searchArr.forEach((item, idx) => {
                var _cur = item.split("=");
                _json[_cur[0]] = _cur[1];
            });
            return _json;
        }

        function guid() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };
    </script>
</body>

</html>